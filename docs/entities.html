<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Entity Graph â€” Deck Family</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; }
    #cy { height: 100vh; width: 100vw; }
    .tooltip {
      position: absolute; padding: 6px 10px; background: #fff;
      border: 1px solid #ccc; border-radius: 5px; font: 14px/1.3 system-ui, sans-serif;
      pointer-events: none; display: none; z-index: 9999;
    }
  h2 {
    text-align: center;
    margin: 1rem 0 0;
    font-size: 1.5rem;
  }

  </style>
</head>
<body>
    <h2>Farm Entity Relationships</h2>
  <div id="cy"></div>

  <!-- Cytoscape CDN -->
  <script src="https://unpkg.com/cytoscape@3/dist/cytoscape.min.js"></script>

  <!-- Embedded JSON (your graph) -->
  <script>
    const embeddedData = {
      "entities": [
        "Deck Family Farm",
        "Community",
        "FFCSA",
        "Creamy Cow",
        "Deck Family Farm Enterprises",
        "Deck Family Trust"
      ],
      "relationships": [
        { "to": "Deck Family Farm", "from": "Community", "note": "lease" },
        { "from": "FFCSA", "to": "Deck Family Farm", "note": "lease" },
        { "from": "Creamy Cow", "to": "Deck Family Farm", "note": "lease" },
        { "from": "Deck Family Farm Enterprises", "to": "Deck Family Farm", "note": "lease" },
        { "to": "Deck Family Trust", "from": "Deck Family Farm", "note": "lease" }
      ]
    };
  </script>

  <script>
    // Helpers
    const slug = s => s.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');

    // Layout rows
    const yTop = 0;
    const yMiddle = 200;
    const yBottom = 600;

    // Colors & styles
    const baseNodeStyle = {
      'background-color': '#2E86AB',
      'label': 'data(label)',
      'color': '#fff',
      'text-valign': 'center',
      'text-halign': 'center',
      'font-size': '20px',
      'shape': 'roundrectangle',
      'text-wrap': 'wrap',
      'text-max-width': '140px',
      'padding': '15px',
      'width': '140px',
      'height': '60px'
    };

    (function init(data) {
      const entities = Array.isArray(data.entities) ? data.entities : [];
      const relationships = Array.isArray(data.relationships) ? data.relationships : [];

      const DFF_LABEL   = 'Deck Family Farm';
      const TRUST_LABEL = 'Deck Family Trust';

      // Top row: everything except DFF & TRUST
      const topLabels = entities.filter(lbl => lbl !== DFF_LABEL && lbl !== TRUST_LABEL);
      const spacing = 220;
      const startX = -((topLabels.length - 1) * spacing) / 2;

      const posById = {};
      topLabels.forEach((lbl, i) => {
        posById[slug(lbl)] = { x: startX + i * spacing, y: yTop };
      });
      posById[slug(DFF_LABEL)]   = { x: 0, y: yMiddle };
      posById[slug(TRUST_LABEL)] = { x: 0, y: yBottom };

      // Nodes
      const nodes = entities.map(lbl => ({
        data: { id: slug(lbl), label: lbl },
        classes: (lbl === TRUST_LABEL) ? 'trust' : '',
        position: posById[slug(lbl)]
      }));

      // Edges
      const edges = relationships.map((r, idx) => {
        const fromId = slug(r.from);
        const toId   = slug(r.to);
        const isLease   = (r.note && r.note.toLowerCase() === 'lease') ||
                          (r.to === TRUST_LABEL && r.note === 'lease');
        const isPercent = !!r.percentage && !isLease;

        return {
          data: {
            id: `e${idx}_${fromId}_${toId}`,
            source: fromId,
            target: toId,
            label: isLease ? 'lease' : (r.percentage ? `${r.percentage}%` : ''),
            note: r.note || '',
            ...(isLease ? { lease: true } : {}),
            ...(isPercent ? { percent: true } : {})
          }
        };
      });

      const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: [...nodes, ...edges],
        style: [
          { selector: 'node', style: baseNodeStyle },
          {
            selector: 'node.trust',
            style: {
              'background-color': '#4CAF50',
              'label': 'data(label)',
              'color': '#fff',
              'font-size': '22px',
              'text-valign': 'center',
              'text-halign': 'center',
              'text-wrap': 'wrap',
              'text-max-width': '10000px',
              'padding': '15px',
              'width': '200px',
              'height': '60px'
            }
          },
          {
            selector: 'edge',
            style: {
              'line-color': '#9CA3AF',
              'target-arrow-color': '#9CA3AF',
              'target-arrow-shape': 'triangle',
              'arrow-scale': 1.2,
              'curve-style': 'bezier',
              'label': 'data(label)',
              'font-size': '14px',
              'text-background-color': '#fff',
              'text-background-opacity': 1,
              'text-background-padding': '2px',
              'text-margin-y': -10,
              'text-rotation': 'horizontal'
            }
          },
          {
            selector: 'edge[percent]',
            style: {
              'line-color': '#FFA500',
              'target-arrow-color': '#FFA500',
              'arrow-scale': 1.5
            }
          },
          {
            selector: 'edge[lease]',
            style: {
              'line-color': '#4CAF50',
              'target-arrow-color': '#4CAF50',
              'line-style': 'dashed',
              'curve-style': 'straight',
              'arrow-scale': 1.5
            }
          }
        ],
        layout: { name: 'preset' },
        userZoomingEnabled: true,
        userPanningEnabled: true,
        wheelSensitivity: 0.2
      });

      // Tooltip for edge notes (kept)
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      document.body.appendChild(tooltip);
      cy.on('mouseover', 'edge', e => {
        const note = e.target.data('note');
        if (note) {
          tooltip.textContent = note;
          tooltip.style.display = 'block';
        }
      });
      cy.on('mouseout', 'edge', () => { tooltip.style.display = 'none'; });
      cy.on('mousemove', e => {
        tooltip.style.left = (e.originalEvent.pageX + 10) + 'px';
        tooltip.style.top  = (e.originalEvent.pageY + 10) + 'px';
      });

      // Show leases/trust by default (no legend/toggle)
      cy.edges('[lease]').style('display', 'element');
      cy.nodes('.trust').style('display', 'element');

      // Stretch + center the green trust bar to span the top row width
      const topXs = topLabels.map(lbl => posById[slug(lbl)].x).sort((a,b) => a - b);
      if (topXs.length > 1) {
        const left = topXs[0];
        const right = topXs[topXs.length - 1];
        const width = right - left + 200; // padding
        const centerX = (left + right) / 2;
        const trustNode = cy.getElementById(slug(TRUST_LABEL));
        trustNode.position({ x: centerX, y: yBottom });
        trustNode.style('width', width + 'px');
      }

      const fit = () => cy.fit(null, 80);
      window.addEventListener('resize', fit);
      fit();
    })(embeddedData);
  </script>
</body>
</html>

